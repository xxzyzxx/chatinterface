<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local LLM Chat</title>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']]
        },
        svg: { fontCache: 'global' }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Sidebar Styles */
        #sidebar {
            width: 250px;
            background-color: #1a1a1a;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
            flex-shrink: 0;
        }
        
        #sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #333;
        }
        
        #new-chat-button {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #new-chat-button:hover {
            background-color: #0056b3;
        }
        
        #new-chat-button svg {
            margin-right: 8px;
        }
        
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .chat-history-item {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-history-item:hover {
            background-color: #2a2a2a;
        }
        
        .chat-history-item.active {
            background-color: #007bff;
        }
        
        /* Main Content Area */
       #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            min-width: 0;
            overflow: hidden;
        }
        
        #model-selector {
            padding: 10px;
            background-color: #1e1e1e;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        
        #model-selector label {
            margin-right: 10px;
            color: #aaa;
        }
        
        #model-select {
            flex-grow: 1;
            padding: 5px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 3px;
            color: #e0e0e0;
        }
        
        /* Chat and Settings Container */
        #chat-and-settings {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }
        
        /* Chat Container */
        #chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #1e1e1e;
            min-width: 0;
            width: calc(100% - 250px); /* Ensure it leaves space for settings sidebar */
        }
        
        #chat-box {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            padding-bottom: 80px; /* Space for input area */
        }
        
        /* Message Styles */
.message {
    margin-bottom: 15px;
    padding: 10px 15px;
    border-radius: 18px;
    max-width: 100%;
    line-height: 1.5;
    word-break: break-word; /* More aggressive word breaking */
    overflow-wrap: anywhere; /* Allows breaking anywhere if needed */
    white-space: pre-wrap; /* Preserve spaces and line breaks but wrap */
    width: fit-content; /* Only take needed width */

}
.user-message {
    background-color: #007bff;
    color: white;
    margin-left: 200px; /* Keep right-aligned */
    margin-right: 0;
    max-width: min(50%, 100%); /* More flexible max-width */
}
        
.ai-message {
    background-color: #3a3a3a;
    color: #e0e0e0;
    margin-right: auto; /* Keep left-aligned */
    max-width: 70%; /* Slightly narrower than user messages */
}
        
        .image-message {
            max-width: 100%;
            border-radius: 8px;
            margin: 5px 0;
        }
        
        /* Thinking bubble styles */
        .thinking-bubble {
            background-color: #2a2a2a;
            border-radius: 18px;
            padding: 10px 15px;
            margin-bottom: 10px;
            max-width: 80%;
            align-self: flex-start;
            border: 1px solid #444;
            font-style: italic;
            color: #aaa;
            position: relative;
        }
        
        .thinking-bubble:after {
            content: '';
            position: absolute;
            left: 20px;
            bottom: -10px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-top-color: #2a2a2a;
            border-bottom: 0;
            border-left: 0;
            margin-left: -10px;
            margin-bottom: -10px;
        }
        
        /* Markdown styling */
        .ai-message h1, .ai-message h2, .ai-message h3, .ai-message h4 {
            margin: 15px 0 10px 0;
            color: #ffffff;
        }
        
        .ai-message h1 {
            font-size: 1.5em;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        
        .ai-message h2 {
            font-size: 1.3em;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        
        .ai-message h3 {
            font-size: 1.1em;
        }
        
        .ai-message h4 {
            font-size: 1em;
        }
        
        .ai-message strong {
            font-weight: bold;
            color: #ffffff;
        }
        
        .ai-message em {
            font-style: italic;
        }
        
        .ai-message code {
            font-family: 'Courier New', Courier, monospace;
            background-color: #2a2a2a;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .ai-message pre {
            background-color: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .ai-message pre code {
            background-color: transparent;
            padding: 0;
        }
        
        .ai-message ul, .ai-message ol {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .ai-message li {
            margin-bottom: 5px;
        }
        
        .ai-message blockquote {
            border-left: 3px solid #007bff;
            padding-left: 10px;
            margin: 10px 0;
            color: #aaa;
        }
        
        .ai-message hr {
            border: none;
            border-top: 1px solid #444;
            margin: 15px 0;
        }
        
        /* MathJax container styling */
        .ai-message .math-container {
            margin: 10px 0;
            padding: 5px;
            text-align: center;
        }
        
        /* Inline math styling */
        .ai-message .math-inline {
            display: inline;
        }
        
        /* Paragraph spacing */
        .ai-message p {
            margin: 8px 0;
        }
        
      /* Input Area */
        #input-area-container {
            position: sticky;
            bottom: 0;
    		width: calc(100% - 280px); /* Match the width with chat-container */
    margin-right: 250px; /* Push it right by the sidebar width */
            background-color: #1e1e1e;
            padding: 15px;
            border-top: 1px solid #333;
            z-index: 10;
            box-sizing: border-box;
        }

        #input-area {
            display: flex;
            width: 100%;
            align-items: center;
        }
        
        #user-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 20px;
            background-color: #2c2c2c;
            color: #e0e0e0;
            font-size: 1rem;
            margin-right: 10px;
        }
        
        #upload-button {
            padding: 10px;
            border: none;
            background-color: transparent;
            color: #e0e0e0;
            cursor: pointer;
            margin-right: 10px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        #upload-button:hover {
            background-color: #333;
        }
        
        #file-input {
            display: none;
        }
        
        #send-button {
            padding: 10px 20px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        
        #send-button:hover {
            background-color: #0056b3;
        }
        
        #send-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            display: inline-block;
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #e0e0e0;
            margin: 0 2px;
            animation: typing 1s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Settings Sidebar */
        #settings-sidebar {
            width: 250px;
            background-color: #1a1a1a;
            border-left: 1px solid #333;
            padding: 15px;
            overflow-y: auto;
            flex-shrink: 0;
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
        }

        #settings-sidebar h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #e0e0e0;
            font-size: 1.2em;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group h3 {
            margin: 0 0 10px 0;
            color: #e0e0e0;
            font-size: 1em;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 0.9em;
        }

        .setting-item input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }

        .setting-item .value-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #888;
        }

        .setting-item input[type="number"] {
            width: 100%;
            padding: 5px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 3px;
            color: #e0e0e0;
        }

        #save-settings {
            width: 100%;
            padding: 8px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        #save-settings:hover {
            background-color: #218838;
        }

        #reset-settings {
            width: 100%;
            padding: 8px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 5px;
        }

        #reset-settings:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

<!-- Left Sidebar -->
<div id="sidebar">
    <div id="sidebar-header">
        <button id="new-chat-button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            New Chat
        </button>
    </div>
    <div id="chat-history">
        <!-- Chat history items will be added here -->
    </div>
</div>

<!-- Main Content Area -->
<div id="main-content">
    <!-- Model Selector -->
    <div id="model-selector">
        <label for="model-select">Model:</label>
        <select id="model-select">
            <option value="">Loading models...</option>
        </select>
    </div>
    
    <!-- Chat and Settings Container -->
    <div id="chat-and-settings">
        <!-- Chat Container -->
<div id="chat-container">
    <div id="chat-box">
        <div class="message ai-message">Hi there! How can I help you today?</div>
    </div>
            
   <!-- Input Area -->
    <div id="input-area-container">
        <form id="input-area">
            <input type="file" id="file-input" accept="image/*" style="display: none;">
            <button type="button" id="upload-button" title="Upload Image">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 16L8.586 11.414C8.961 11.039 9.47 10.828 10 10.828C10.53 10.828 11.039 11.039 11.414 11.414L16 16M14 14L15.586 12.414C15.961 12.039 16.47 11.828 17 11.828C17.53 11.828 18.039 12.039 18.414 12.414L20 14M14 8H14.01M6 20H18C19.1046 20 20 19.1046 20 18V6C20 4.89543 19.1046 4 18 4H6C4.89543 4 4 4.89543 4 6V18C4 19.1046 4.89543 20 6 20Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <input type="text" id="user-input" placeholder="Type your message..." autocomplete="off">
            <button id="send-button" type="submit">Send</button>
        </form>
    </div>
</div>        
        <!-- Settings Sidebar -->
        <div id="settings-sidebar">
            <h2>Generation Settings</h2>
            
            <div class="settings-group">
                <h3>Parameters</h3>
                
                <div class="setting-item">
                    <label for="temperature">Temperature</label>
                    <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7">
                    <div class="value-display">
                        <span>0 (Deterministic)</span>
                        <span id="temperature-value">0.7</span>
                        <span>2 (Creative)</span>
                    </div>
                </div>
                
                <div class="setting-item">
                    <label for="top-k">Top K Sampling</label>
                    <input type="number" id="top-k" min="0" max="100" step="1" value="40">
                    <div class="value-display">
                        <span>0 (Disabled)</span>
                        <span>100 (Max)</span>
                    </div>
                </div>
                
                <div class="setting-item">
                    <label for="top-p">Top P Sampling</label>
                    <input type="range" id="top-p" min="0" max="1" step="0.05" value="0.9">
                    <div class="value-display">
                        <span>0 (Strict)</span>
                        <span id="top-p-value">0.9</span>
                        <span>1 (Broad)</span>
                    </div>
                </div>
                
                <div class="setting-item">
                    <label for="min-p">Min P Sampling</label>
                    <input type="range" id="min-p" min="0" max="1" step="0.05" value="0.05">
                    <div class="value-display">
                        <span>0 (Disabled)</span>
                        <span id="min-p-value">0.05</span>
                        <span>1 (Max)</span>
                    </div>
                </div>
                
                <div class="setting-item">
                    <label for="repeat-penalty">Repeat Penalty</label>
                    <input type="range" id="repeat-penalty" min="1" max="2" step="0.1" value="1.1">
                    <div class="value-display">
                        <span>1 (None)</span>
                        <span id="repeat-penalty-value">1.1</span>
                        <span>2 (Strong)</span>
                    </div>
                </div>
            </div>
            
            <button id="save-settings">Save Settings</button>
            <button id="reset-settings">Reset to Defaults</button>
        </div>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const inputForm = document.getElementById('input-area');
    const newChatButton = document.getElementById('new-chat-button');
    const chatHistoryContainer = document.getElementById('chat-history');
    const modelSelect = document.getElementById('model-select');
    const uploadButton = document.getElementById('upload-button');
    const fileInput = document.getElementById('file-input');

    // Settings elements
    const temperatureSlider = document.getElementById('temperature');
    const temperatureValue = document.getElementById('temperature-value');
    const topKInput = document.getElementById('top-k');
    const topPSlider = document.getElementById('top-p');
    const topPValue = document.getElementById('top-p-value');
    const minPSlider = document.getElementById('min-p');
    const minPValue = document.getElementById('min-p-value');
    const repeatPenaltySlider = document.getElementById('repeat-penalty');
    const repeatPenaltyValue = document.getElementById('repeat-penalty-value');
    const saveSettingsButton = document.getElementById('save-settings');
    const resetSettingsButton = document.getElementById('reset-settings');

    // Current model settings
    let modelSettings = {
        temperature: 0.7,
        top_k: 40,
        top_p: 0.9,
        min_p: 0.05,
        repeat_penalty: 1.1
    };

    // Current model
    let currentModel = '';

    // API endpoints
    const apiBaseUrl = 'https://llm.empireofdusk.org';
    const apiUrl = `${apiBaseUrl}/v1/chat/completions`;
    const modelsUrl = `${apiBaseUrl}/v1/models`;

    // Store all conversations
    let conversations = [];
    let currentConversationId = null;

    // Initialize with a new conversation
    function initNewConversation() {
    chatBox.innerHTML = '';
        const newConversation = {
            id: Date.now().toString(),
            title: 'New Chat',
            messages: [{
                role: 'system',
                content: 'You are a helpful AI assistant that can analyze images. When users upload images, describe them in detail and answer any questions about them.'
            },
            {
                role: 'user',
                content: 'Hello!',
                hidden: true
            },   
            {
                role: 'assistant',
                content: 'Hi there! How can I help you today? You can upload images for me to analyze.'
            }]
        };
        currentConversationId = newConversation.id;
        conversations.push(newConversation);
        renderChatHistory();
        renderCurrentConversation();
    }

    // Render the chat history sidebar
    function renderChatHistory() {
        chatHistoryContainer.innerHTML = '';
        
        conversations.forEach(conversation => {
            const historyItem = document.createElement('div');
            historyItem.className = `chat-history-item ${conversation.id === currentConversationId ? 'active' : ''}`;
            historyItem.textContent = conversation.title;
            historyItem.addEventListener('click', () => {
                switchToConversation(conversation.id);
            });
            chatHistoryContainer.appendChild(historyItem);
        });
    }

    // Switch to a different conversation
    function switchToConversation(conversationId) {
        currentConversationId = conversationId;
        renderChatHistory();
        renderCurrentConversation();
    }

    function parseMarkdown(text) {
        const placeholder = `\uE000${Math.random().toString(36).slice(2)}\uE001`;
        const latexBlocks = [];
        let index = 0;

        const latexRegex = /(\$\$[\s\S]+?\$\$|\$[^$\n]+\$|\\\([^\)]+\\\)|\\\[[^\]]+\\\])/g;

        text = text.replace(latexRegex, match => {
            const token = `${placeholder}${index}${placeholder}`;
            latexBlocks.push(match);
            index++;
            return token;
        });

        text = text
            .replace(/^####\s+(.*)$/gm, '<h4>$1</h4>')
            .replace(/^###\s+(.*)$/gm, '<h3>$1</h3>')
            .replace(/^##\s+(.*)$/gm, '<h2>$1</h2>')
            .replace(/^#\s+(.*)$/gm, '<h1>$1</h1>')
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
            .replace(/\*([^*]+)\*/g, '<em>$1</em>')
            .replace(/```([a-z]*)\n([\s\S]*?)\n```/g, '<pre><code class="language-$1">$2</code></pre>')
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            .replace(/^>\s+(.*)$/gm, '<blockquote>$1</blockquote>')
            .replace(/^\s*---\s*$/gm, '<hr>')
            .replace(/^\s*-\s+(.*)$/gm, '<li>$1</li>')
            .replace(/^\s*\d+\.\s+(.*)$/gm, '<li>$1</li>')
            .replace(/(<li>.*<\/li>)+/gs, match => `<ul>${match}</ul>`);

        const lines = text.split('\n');
        const output = [];
        let buffer = [];

        const flush = () => {
            if (buffer.length > 0) {
                output.push(`<p>${buffer.join(' ')}</p>`);
                buffer = [];
            }
        };

        for (const line of lines) {
            const trimmed = line.trim();
            if (!trimmed) {
                flush();
            } else if (/^<(h\d|ul|ol|pre|blockquote|div|hr|p|li)/.test(trimmed)) {
                flush();
                output.push(trimmed);
            } else {
                buffer.push(trimmed);
            }
        }
        flush();

        const restoreRegex = new RegExp(`${placeholder}(\\d+)${placeholder}`, 'g');
        const finalHtml = output.join('\n').replace(restoreRegex, (_, i) => latexBlocks[+i]);

        return finalHtml.trim();
    }

    // Function to render MathJax in a specific element
    function renderMath(element) {
        if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise([element]).catch(err => console.log('MathJax typeset error:', err));
        }
    }

    // Render the current conversation in the chat box
    function renderCurrentConversation() {
        visibleMessages = conversation.messages.filter(msg => !msg.hidden);
        const conversation = conversations.find(c => c.id === currentConversationId);
        if (!conversation) return;
        
        chatBox.innerHTML = '';
        
        conversation.messages.forEach(msg => {
            if (msg.role === 'user' || msg.role === 'assistant') {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', msg.role === 'user' ? 'user-message' : 'ai-message');
                
                if (msg.role === 'assistant') {
                    messageElement.innerHTML = parseMarkdown(msg.content);
                    renderMath(messageElement);
                } else if (msg.image) {
                    const img = document.createElement('img');
                    img.src = msg.image;
                    img.classList.add('image-message');
                    messageElement.appendChild(img);
                    if (msg.content) {
                        const text = document.createElement('div');
                        text.textContent = msg.content;
                        messageElement.appendChild(text);
                    }
                } else {
                    messageElement.textContent = msg.content;
                }
                
                chatBox.appendChild(messageElement);
            }
        });
        
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Function to add a message to the chat display
    const addMessage = (content, sender, imageUrl = null) => {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', `${sender}-message`);
        
        if (sender === 'ai') {
            messageElement.innerHTML = parseMarkdown(content);
            renderMath(messageElement);
        } else if (imageUrl) {
            const img = document.createElement('img');
            img.src = imageUrl;
            img.classList.add('image-message');
            messageElement.appendChild(img);
            if (content) {
                const text = document.createElement('div');
                text.textContent = content;
                messageElement.appendChild(text);
            }
        } else {
            messageElement.textContent = content;
        }
        
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight;
        return messageElement;
    };

    // Function to add a thinking bubble
    const addThinkingBubble = (content) => {
        const bubble = document.createElement('div');
        bubble.classList.add('thinking-bubble');
        bubble.textContent = content;
        chatBox.appendChild(bubble);
        chatBox.scrollTop = chatBox.scrollHeight;
        return bubble;
    };

    // Update slider value displays
    function updateSliderDisplays() {
        temperatureValue.textContent = temperatureSlider.value;
        topPValue.textContent = topPSlider.value;
        minPValue.textContent = minPSlider.value;
        repeatPenaltyValue.textContent = repeatPenaltySlider.value;
    }

    // Load settings from localStorage
    function loadSettings() {
        const savedSettings = localStorage.getItem('modelSettings');
        if (savedSettings) {
            modelSettings = JSON.parse(savedSettings);
            
            temperatureSlider.value = modelSettings.temperature;
            topKInput.value = modelSettings.top_k;
            topPSlider.value = modelSettings.top_p;
            minPSlider.value = modelSettings.min_p;
            repeatPenaltySlider.value = modelSettings.repeat_penalty;
            
            updateSliderDisplays();
        }
    }

    // Save settings to localStorage
    function saveSettings() {
        modelSettings = {
            temperature: parseFloat(temperatureSlider.value),
            top_k: parseInt(topKInput.value),
            top_p: parseFloat(topPSlider.value),
            min_p: parseFloat(minPSlider.value),
            repeat_penalty: parseFloat(repeatPenaltySlider.value)
        };
        
        localStorage.setItem('modelSettings', JSON.stringify(modelSettings));
        alert('Settings saved!');
    }

    // Reset settings to defaults
    function resetSettings() {
        if (confirm('Reset all settings to default values?')) {
            temperatureSlider.value = 0.7;
            topKInput.value = 40;
            topPSlider.value = 0.9;
            minPSlider.value = 0.05;
            repeatPenaltySlider.value = 1.1;
            
            updateSliderDisplays();
            saveSettings();
        }
    }

    // Fetch available models from server
    async function fetchModels() {
        try {
            const response = await fetch(modelsUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data.data.map(model => model.id);
        } catch (error) {
            console.error('Failed to fetch models:', error);
            return [];
        }
    }

    // Populate model dropdown with available models
    async function populateModelDropdown() {
        const modelSelect = document.getElementById('model-select');
        modelSelect.innerHTML = '<option value="">Loading models...</option>';
        
        const models = await fetchModels();
        
        if (models.length === 0) {
            modelSelect.innerHTML = '<option value="">No models available</option>';
            return;
        }
        
        modelSelect.innerHTML = '';
        
        models.forEach(model => {
            const option = document.createElement('option');
            option.value = model;
            option.textContent = model;
            modelSelect.appendChild(option);
        });
        
        if (models.length > 0) {
            currentModel = models[0];
            modelSelect.value = models[0];
        }
    }

    // Handle image upload
    function handleImageUpload(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64String = e.target.result.split(',')[1];
                resolve({
                    url: e.target.result,
                    base64: base64String
                });
            };
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
        });
    }

    // Handle form submission
    inputForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userMessage = userInput.value.trim();
        if (!userMessage && !fileInput.files[0]) return;

        let conversation = conversations.find(c => c.id === currentConversationId);
        if (!conversation) {
            initNewConversation();
            conversation = conversations.find(c => c.id === currentConversationId);
        }

        let imageData = null;
        if (fileInput.files[0]) {
            try {
                imageData = await handleImageUpload(fileInput.files[0]);
                addMessage(userMessage || 'Image uploaded', 'user', imageData.url);
                
                conversation.messages.push({ 
                    role: 'user', 
                    content: userMessage || 'Image uploaded',
                    image: imageData.url
                });
                
                fileInput.value = '';
            } catch (error) {
                console.error('Error uploading image:', error);
                addMessage('Error uploading image', 'ai');
                return;
            }
        } else {
            addMessage(userMessage, 'user');
            conversation.messages.push({ role: 'user', content: userMessage });
        }
        
        if (conversation.messages.filter(m => m.role === 'user').length === 1) {
            conversation.title = userMessage.length > 30 ? userMessage.substring(0, 30) + '...' : userMessage;
            renderChatHistory();
        }
        
        userInput.value = '';
        sendButton.disabled = true;

        const typingIndicator = document.createElement('div');
        typingIndicator.classList.add('message', 'ai-message');
        typingIndicator.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
        chatBox.appendChild(typingIndicator);
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            const messagesToSend = [
                conversation.messages[0],
                ...conversation.messages.slice(-6)
            ];

            const apiMessages = messagesToSend.map(msg => {
                if (msg.image && msg.role === 'user') {
                    return {
                        role: msg.role,
                        content: [
                            { type: 'text', text: msg.content || 'Describe this image' },
                            { 
                                type: 'image_url',
                                image_url: {
                                    url: `data:image/jpeg;base64,${imageData.base64}`
                                }
                            }
                        ]
                    };
                } else {
                    return {
                        role: msg.role,
                        content: msg.content
                    };
                }
            });

            const responseContainer = document.createElement('div');
            responseContainer.classList.add('message', 'ai-message');
            chatBox.removeChild(typingIndicator);
            chatBox.appendChild(responseContainer);
            
            let thinkingBubble = null;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: currentModel,
                    messages: apiMessages,
                    temperature: modelSettings.temperature,
                    top_k: modelSettings.top_k,
                    top_p: modelSettings.top_p,
                    min_p: modelSettings.min_p,
                    repeat_penalty: modelSettings.repeat_penalty,
                    stream: true
                }),
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullResponse = '';
            let buffer = '';
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();
                
                for (const line of lines) {
                    if (line.startsWith('data:') && !line.includes('[DONE]')) {
                        try {
                            const data = JSON.parse(line.substring(5).trim());
                            const content = data.choices[0].delta.content;
                            
                            if (content) {
                                fullResponse += content;
                                
                                if (content.includes('Thought:') || (thinkingBubble && !fullResponse.includes('\n\n'))) {
                                    if (!thinkingBubble) {
                                        thinkingBubble = addThinkingBubble(content);
                                    } else {
                                        thinkingBubble.textContent += content;
                                    }
                                } else {
                                    if (thinkingBubble) {
                                        chatBox.removeChild(thinkingBubble);
                                        thinkingBubble = null;
                                    }
                                    
                                    responseContainer.innerHTML = parseMarkdown(fullResponse);
                                    renderMath(responseContainer);
                                }
                                
                                chatBox.scrollTop = chatBox.scrollHeight;
                            }
                        } catch (e) {
                            console.error('Error parsing stream data:', e);
                        }
                    }
                }
            }

            responseContainer.innerHTML = parseMarkdown(fullResponse);
            renderMath(responseContainer);
            
            conversation.messages.push({ role: 'assistant', content: fullResponse });

        } catch (error) {
            console.error('Error fetching from local LLM:', error);
            chatBox.removeChild(typingIndicator);
            addMessage(`Error: Could not connect to the model. Make sure the server supports image processing. (${error.message})`, 'ai');
        } finally {
            sendButton.disabled = false;
            userInput.focus();
        }
    });

    // Handle upload button click
    uploadButton.addEventListener('click', () => {
        fileInput.click();
    });

    // Handle file selection
    fileInput.addEventListener('change', () => {
        if (fileInput.files[0]) {
            console.log('Image selected:', fileInput.files[0].name);
        }
    });

    // Handle new chat button
    newChatButton.addEventListener('click', (e) => {
        e.preventDefault();
        initNewConversation();
    // Clear any existing input
    userInput.value = '';
    fileInput.value = '';
    
    // Focus the input for new message
    userInput.focus();
    });

    // Handle model selection change
    modelSelect.addEventListener('change', (e) => {
        currentModel = e.target.value;
        initNewConversation();
    });

    // Initialize slider value displays
    temperatureSlider.addEventListener('input', updateSliderDisplays);
    topPSlider.addEventListener('input', updateSliderDisplays);
    minPSlider.addEventListener('input', updateSliderDisplays);
    repeatPenaltySlider.addEventListener('input', updateSliderDisplays);

    // Handle settings buttons
    saveSettingsButton.addEventListener('click', (e) => {
        e.preventDefault();
        saveSettings();
    });

    resetSettingsButton.addEventListener('click', (e) => {
        e.preventDefault();
        resetSettings();
    });

    // Initialize the app
    async function initialize() {
        await populateModelDropdown();
        loadSettings();
        initNewConversation();
    }

    // Start the application
    initialize();
</script>
</body>
</html>
