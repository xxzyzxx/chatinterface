<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local LLM Chat</title>
    <!-- Add MathJax for LaTeX rendering -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']]
    },
    svg: { fontCache: 'global' }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        #sidebar {
            width: 250px;
            background-color: #1a1a1a;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        #sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #333;
        }
        
        #new-chat-button {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #new-chat-button:hover {
            background-color: #0056b3;
        }
        
        #new-chat-button svg {
            margin-right: 8px;
        }
        
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .chat-history-item {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-history-item:hover {
            background-color: #2a2a2a;
        }
        
        .chat-history-item.active {
            background-color: #007bff;
        }
        
        #main-content {
            flex-grow: 1;
            display: flex;
            height: 100vh;
        }
        
        #chat-container {
            flex-grow: 1;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #1e1e1e;
        }
        
        #chat-box {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.5;
        }
        
        .user-message {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .ai-message {
            background-color: #3a3a3a;
            color: #e0e0e0;
            align-self: flex-start;
        }
        
        /* Thinking bubble styles */
        .thinking-bubble {
            background-color: #2a2a2a;
            border-radius: 18px;
            padding: 10px 15px;
            margin-bottom: 10px;
            max-width: 80%;
            align-self: flex-start;
            border: 1px solid #444;
            font-style: italic;
            color: #aaa;
            position: relative;
        }
        
        .thinking-bubble:after {
            content: '';
            position: absolute;
            left: 20px;
            bottom: -10px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-top-color: #2a2a2a;
            border-bottom: 0;
            border-left: 0;
            margin-left: -10px;
            margin-bottom: -10px;
        }
        
        /* Markdown styling */
        .ai-message h1, .ai-message h2, .ai-message h3, .ai-message h4 {
            margin: 15px 0 10px 0;
            color: #ffffff;
        }
        
        .ai-message h1 {
            font-size: 1.5em;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        
        .ai-message h2 {
            font-size: 1.3em;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        
        .ai-message h3 {
            font-size: 1.1em;
        }
        
        .ai-message h4 {
            font-size: 1em;
        }
        
        .ai-message strong {
            font-weight: bold;
            color: #ffffff;
        }
        
        .ai-message em {
            font-style: italic;
        }
        
        .ai-message code {
            font-family: 'Courier New', Courier, monospace;
            background-color: #2a2a2a;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .ai-message pre {
            background-color: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .ai-message pre code {
            background-color: transparent;
            padding: 0;
        }
        
        .ai-message ul, .ai-message ol {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .ai-message li {
            margin-bottom: 5px;
        }
        
        .ai-message blockquote {
            border-left: 3px solid #007bff;
            padding-left: 10px;
            margin: 10px 0;
            color: #aaa;
        }
        
        .ai-message hr {
            border: none;
            border-top: 1px solid #444;
            margin: 15px 0;
        }
        
        /* MathJax container styling */
        .ai-message .math-container {
            margin: 10px 0;
            padding: 5px;
            text-align: center;
        }
        
        /* Inline math styling */
        .ai-message .math-inline {
            display: inline;
        }
        
        /* Paragraph spacing */
        .ai-message p {
            margin: 8px 0;
        }
        
        #input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid #333;
            background-color: #1e1e1e;
        }
        
        #user-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 20px;
            background-color: #2c2c2c;
            color: #e0e0e0;
            font-size: 1rem;
            margin-right: 10px;
        }
        
        #send-button {
            padding: 10px 20px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        
        #send-button:hover {
            background-color: #0056b3;
        }
        
        #send-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            display: inline-block;
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #e0e0e0;
            margin: 0 2px;
            animation: typing 1s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Settings sidebar styles */
        #settings-sidebar {
            width: 250px;
            background-color: #1a1a1a;
            border-left: 1px solid #333;
            padding: 15px;
            overflow-y: auto;
        }

        #settings-sidebar h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #e0e0e0;
            font-size: 1.2em;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group h3 {
            margin: 0 0 10px 0;
            color: #e0e0e0;
            font-size: 1em;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 0.9em;
        }

        .setting-item input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }

        .setting-item .value-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #888;
        }

        .setting-item input[type="number"] {
            width: 100%;
            padding: 5px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 3px;
            color: #e0e0e0;
        }

        #save-settings {
            width: 100%;
            padding: 8px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        #save-settings:hover {
            background-color: #218838;
        }

        #reset-settings {
            width: 100%;
            padding: 8px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 5px;
        }

        #reset-settings:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div id="sidebar-header">
        <button id="new-chat-button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            New Chat
        </button>
    </div>
    <div id="chat-history">
        <!-- Chat history items will be added here -->
    </div>
</div>

<div id="main-content">
    <div id="chat-container">
        <div id="chat-box">
            <div class="message ai-message">Hi there! How can I help you today?</div>
        </div>
        <form id="input-area">
            <input type="text" id="user-input" placeholder="Type your message..." autocomplete="off">
            <button id="send-button" type="submit">Send</button>
        </form>
    </div>
</div>

<div id="settings-sidebar">
    <h2>Model Settings</h2>
    
    <div class="settings-group">
        <h3>Generation Parameters</h3>
        
        <div class="setting-item">
            <label for="temperature">Temperature</label>
            <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7">
            <div class="value-display">
                <span>0 (Deterministic)</span>
                <span id="temperature-value">0.7</span>
                <span>2 (Creative)</span>
            </div>
        </div>
        
        <div class="setting-item">
            <label for="top-k">Top K Sampling</label>
            <input type="number" id="top-k" min="0" max="100" step="1" value="40">
            <div class="value-display">
                <span>0 (Disabled)</span>
                <span>100 (Max)</span>
            </div>
        </div>
        
        <div class="setting-item">
            <label for="top-p">Top P Sampling</label>
            <input type="range" id="top-p" min="0" max="1" step="0.05" value="0.9">
            <div class="value-display">
                <span>0 (Strict)</span>
                <span id="top-p-value">0.9</span>
                <span>1 (Broad)</span>
            </div>
        </div>
        
        <div class="setting-item">
            <label for="min-p">Min P Sampling</label>
            <input type="range" id="min-p" min="0" max="1" step="0.05" value="0.05">
            <div class="value-display">
                <span>0 (Disabled)</span>
                <span id="min-p-value">0.05</span>
                <span>1 (Max)</span>
            </div>
        </div>
        
        <div class="setting-item">
            <label for="repeat-penalty">Repeat Penalty</label>
            <input type="range" id="repeat-penalty" min="1" max="2" step="0.1" value="1.1">
            <div class="value-display">
                <span>1 (None)</span>
                <span id="repeat-penalty-value">1.1</span>
                <span>2 (Strong)</span>
            </div>
        </div>
    </div>
    
    <button id="save-settings">Save Settings</button>
    <button id="reset-settings">Reset to Defaults</button>
</div>

<script>
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const inputForm = document.getElementById('input-area');
    const newChatButton = document.getElementById('new-chat-button');
    const chatHistoryContainer = document.getElementById('chat-history');

    // Settings elements
    const temperatureSlider = document.getElementById('temperature');
    const temperatureValue = document.getElementById('temperature-value');
    const topKInput = document.getElementById('top-k');
    const topPSlider = document.getElementById('top-p');
    const topPValue = document.getElementById('top-p-value');
    const minPSlider = document.getElementById('min-p');
    const minPValue = document.getElementById('min-p-value');
    const repeatPenaltySlider = document.getElementById('repeat-penalty');
    const repeatPenaltyValue = document.getElementById('repeat-penalty-value');
    const saveSettingsButton = document.getElementById('save-settings');
    const resetSettingsButton = document.getElementById('reset-settings');

    // Current model settings
    let modelSettings = {
        temperature: 0.7,
        top_k: 40,
        top_p: 0.9,
        min_p: 0.05,
        repeat_penalty: 1.1
    };

    // !!! IMPORTANT: Replace this URL with your Cloudflare Tunnel domain
    const apiUrl = 'https://llm.empireofdusk.org/v1/chat/completions';

    // Store all conversations
    let conversations = [];
    let currentConversationId = null;

    // Initialize with a new conversation
    function initNewConversation() {
        const newConversation = {
            id: Date.now().toString(),
            title: 'New Chat',
            messages: [{
                role: 'system',
                content: 'You are a helpful AI assistant.'
            }, {
                role: 'assistant',
                content: 'Hi there! How can I help you today?'
            }]
        };
        
        currentConversationId = newConversation.id;
        conversations.push(newConversation);
        renderChatHistory();
        renderCurrentConversation();
    }

    // Render the chat history sidebar
    function renderChatHistory() {
        chatHistoryContainer.innerHTML = '';
        
        conversations.forEach(conversation => {
            const historyItem = document.createElement('div');
            historyItem.className = `chat-history-item ${conversation.id === currentConversationId ? 'active' : ''}`;
            historyItem.textContent = conversation.title;
            historyItem.addEventListener('click', () => {
                switchToConversation(conversation.id);
            });
            chatHistoryContainer.appendChild(historyItem);
        });
    }

    // Switch to a different conversation
    function switchToConversation(conversationId) {
        currentConversationId = conversationId;
        renderChatHistory();
        renderCurrentConversation();
    }

    function parseMarkdown(text) {
        // STEP 1: Protect LaTeX blocks so Markdown doesn't touch them
        const placeholder = `\uE000${Math.random().toString(36).slice(2)}\uE001`;
        const latexBlocks = [];
        let index = 0;

        // Regex to match LaTeX expressions: $$...$$, $...$, \( ... \), \[ ... \]
        const latexRegex = /(\$\$[\s\S]+?\$\$|\$[^$\n]+\$|\\\([^\)]+\\\)|\\\[[^\]]+\\\])/g;

        text = text.replace(latexRegex, match => {
            const token = `${placeholder}${index}${placeholder}`;
            latexBlocks.push(match);
            index++;
            return token;
        });

        // STEP 2: Apply Markdown formatting
        text = text
            .replace(/^####\s+(.*)$/gm, '<h4>$1</h4>')
            .replace(/^###\s+(.*)$/gm, '<h3>$1</h3>')
            .replace(/^##\s+(.*)$/gm, '<h2>$1</h2>')
            .replace(/^#\s+(.*)$/gm, '<h1>$1</h1>')
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
            .replace(/\*([^*]+)\*/g, '<em>$1</em>')
            .replace(/```([a-z]*)\n([\s\S]*?)\n```/g, '<pre><code class="language-$1">$2</code></pre>')
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            .replace(/^>\s+(.*)$/gm, '<blockquote>$1</blockquote>')
            .replace(/^\s*---\s*$/gm, '<hr>')
            .replace(/^\s*-\s+(.*)$/gm, '<li>$1</li>')
            .replace(/^\s*\d+\.\s+(.*)$/gm, '<li>$1</li>')
            .replace(/(<li>.*<\/li>)+/gs, match => `<ul>${match}</ul>`);

        // STEP 3: Wrap non-block lines in <p> tags
        const lines = text.split('\n');
        const output = [];
        let buffer = [];

        const flush = () => {
            if (buffer.length > 0) {
                output.push(`<p>${buffer.join(' ')}</p>`);
                buffer = [];
            }
        };

        for (const line of lines) {
            const trimmed = line.trim();
            if (!trimmed) {
                flush();
            } else if (/^<(h\d|ul|ol|pre|blockquote|div|hr|p|li)/.test(trimmed)) {
                flush();
                output.push(trimmed);
            } else {
                buffer.push(trimmed);
            }
        }
        flush();

        // STEP 4: Restore LaTeX expressions
        const restoreRegex = new RegExp(`${placeholder}(\\d+)${placeholder}`, 'g');
        const finalHtml = output.join('\n').replace(restoreRegex, (_, i) => latexBlocks[+i]);

        return finalHtml.trim();
    }

    // Function to render MathJax in a specific element
    function renderMath(element) {
        if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise([element]).catch(err => console.log('MathJax typeset error:', err));
        }
    }

    // Render the current conversation in the chat box
    function renderCurrentConversation() {
        const conversation = conversations.find(c => c.id === currentConversationId);
        if (!conversation) return;
        
        chatBox.innerHTML = '';
        
        // Only render user and assistant messages (skip system messages)
        conversation.messages.forEach(msg => {
            if (msg.role === 'user' || msg.role === 'assistant') {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', msg.role === 'user' ? 'user-message' : 'ai-message');
                
                if (msg.role === 'assistant') {
                    // Parse markdown for AI messages
                    messageElement.innerHTML = parseMarkdown(msg.content);
                    // Render any math in this message
                    renderMath(messageElement);
                } else {
                    // Keep user messages as plain text (or parse if you want)
                    messageElement.textContent = msg.content;
                }
                
                chatBox.appendChild(messageElement);
            }
        });
        
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Function to add a message to the chat display
    const addMessage = (content, sender) => {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', `${sender}-message`);
        
        if (sender === 'ai') {
            // Parse markdown for AI messages
            messageElement.innerHTML = parseMarkdown(content);
            // Render any math in this message
            renderMath(messageElement);
        } else {
            // Keep user messages as plain text
            messageElement.textContent = content;
        }
        
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll to the bottom
        return messageElement;
    };

    // Function to add a thinking bubble
    const addThinkingBubble = (content) => {
        const bubble = document.createElement('div');
        bubble.classList.add('thinking-bubble');
        bubble.textContent = content;
        chatBox.appendChild(bubble);
        chatBox.scrollTop = chatBox.scrollHeight;
        return bubble;
    };

    // Update slider value displays
    function updateSliderDisplays() {
        temperatureValue.textContent = temperatureSlider.value;
        topPValue.textContent = topPSlider.value;
        minPValue.textContent = minPSlider.value;
        repeatPenaltyValue.textContent = repeatPenaltySlider.value;
    }

    // Load settings from localStorage
    function loadSettings() {
        const savedSettings = localStorage.getItem('modelSettings');
        if (savedSettings) {
            modelSettings = JSON.parse(savedSettings);
            
            // Update UI elements
            temperatureSlider.value = modelSettings.temperature;
            topKInput.value = modelSettings.top_k;
            topPSlider.value = modelSettings.top_p;
            minPSlider.value = modelSettings.min_p;
            repeatPenaltySlider.value = modelSettings.repeat_penalty;
            
            updateSliderDisplays();
        }
    }

    // Save settings to localStorage
    function saveSettings() {
        modelSettings = {
            temperature: parseFloat(temperatureSlider.value),
            top_k: parseInt(topKInput.value),
            top_p: parseFloat(topPSlider.value),
            min_p: parseFloat(minPSlider.value),
            repeat_penalty: parseFloat(repeatPenaltySlider.value)
        };
        
        localStorage.setItem('modelSettings', JSON.stringify(modelSettings));
        alert('Settings saved!');
    }

    // Reset settings to defaults
    function resetSettings() {
        if (confirm('Reset all settings to default values?')) {
            temperatureSlider.value = 0.7;
            topKInput.value = 40;
            topPSlider.value = 0.9;
            minPSlider.value = 0.05;
            repeatPenaltySlider.value = 1.1;
            
            updateSliderDisplays();
            saveSettings();
        }
    }

    // Handle form submission
    inputForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userMessage = userInput.value.trim();
        if (!userMessage) return;

        // Get current conversation
        let conversation = conversations.find(c => c.id === currentConversationId);
        if (!conversation) {
            initNewConversation();
            conversation = conversations.find(c => c.id === currentConversationId);
        }

        // Add user message to conversation
        addMessage(userMessage, 'user');
        conversation.messages.push({ role: 'user', content: userMessage });
        
        // Update conversation title if this is the first user message
        if (conversation.messages.filter(m => m.role === 'user').length === 1) {
            conversation.title = userMessage.length > 30 ? userMessage.substring(0, 30) + '...' : userMessage;
            renderChatHistory();
        }
        
        userInput.value = '';
        sendButton.disabled = true;

        // Add a typing indicator
        const typingIndicator = document.createElement('div');
        typingIndicator.classList.add('message', 'ai-message');
        typingIndicator.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
        chatBox.appendChild(typingIndicator);
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            // Only send system message and the last few messages to avoid hitting token limits
            const messagesToSend = [
                conversation.messages[0], // system message
                ...conversation.messages.slice(-6) // last 3 exchanges (user + assistant)
            ];

            // Create a response container that we'll stream into
            const responseContainer = document.createElement('div');
            responseContainer.classList.add('message', 'ai-message');
            chatBox.removeChild(typingIndicator);
            chatBox.appendChild(responseContainer);
            
            // Create a thinking bubble container (will be shown if chain-of-thought is used)
            let thinkingBubble = null;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: 'local-model',
                    messages: messagesToSend,
                    temperature: modelSettings.temperature,
                    top_k: modelSettings.top_k,
                    top_p: modelSettings.top_p,
                    min_p: modelSettings.min_p,
                    repeat_penalty: modelSettings.repeat_penalty,
                    stream: true
                }),
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }

            // Process the streaming response
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullResponse = '';
            let buffer = '';
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep the last incomplete line in buffer
                
                for (const line of lines) {
                    if (line.startsWith('data:') && !line.includes('[DONE]')) {
                        try {
                            const data = JSON.parse(line.substring(5).trim());
                            const content = data.choices[0].delta.content;
                            
                            if (content) {
                                fullResponse += content;
                                
                                // Check if this is chain-of-thought (might start with "Thought:" or similar)
                                if (content.includes('Thought:') || (thinkingBubble && !fullResponse.includes('\n\n'))) {
                                    if (!thinkingBubble) {
                                        thinkingBubble = addThinkingBubble(content);
                                    } else {
                                        thinkingBubble.textContent += content;
                                    }
                                } else {
                                    // If we had a thinking bubble but now we're in the main response, remove it
                                    if (thinkingBubble) {
                                        chatBox.removeChild(thinkingBubble);
                                        thinkingBubble = null;
                                    }
                                    
                                    // Update the main response
                                    responseContainer.innerHTML = parseMarkdown(fullResponse);
                                    renderMath(responseContainer);
                                }
                                
                                chatBox.scrollTop = chatBox.scrollHeight;
                            }
                        } catch (e) {
                            console.error('Error parsing stream data:', e);
                        }
                    }
                }
            }

            // Final update to ensure all content is rendered
            responseContainer.innerHTML = parseMarkdown(fullResponse);
            renderMath(responseContainer);
            
            // Add the final response to the conversation history
            conversation.messages.push({ role: 'assistant', content: fullResponse });

        } catch (error) {
            console.error('Error fetching from local LLM:', error);
            chatBox.removeChild(typingIndicator);
            addMessage(`Error: Could not connect to the model. Make sure LM Studio server and Cloudflare Tunnel are running. (${error.message})`, 'ai');
        } finally {
            sendButton.disabled = false;
            userInput.focus();
        }
    });

    // Handle new chat button
    newChatButton.addEventListener('click', (e) => {
        e.preventDefault();
        initNewConversation();
    });

    // Initialize slider value displays
    temperatureSlider.addEventListener('input', updateSliderDisplays);
    topPSlider.addEventListener('input', updateSliderDisplays);
    minPSlider.addEventListener('input', updateSliderDisplays);
    repeatPenaltySlider.addEventListener('input', updateSliderDisplays);

    // Handle settings buttons
    saveSettingsButton.addEventListener('click', (e) => {
        e.preventDefault();
        saveSettings();
    });

    resetSettingsButton.addEventListener('click', (e) => {
        e.preventDefault();
        resetSettings();
    });

    // Initialize the app
    loadSettings();
</script>
</body>
</html>
